import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from scipy.stats import f
from scipy.linalg import pinv

def load_and_preprocess_gene_data(filepath):
    raw_data = pd.read_csv(filepath, sep="\t", header=0)  # Assuming the first row is the header

    # Deleting the Go column
    raw_data.drop(columns=['Go'], inplace=True)

    # Deleting rows with NaN in GeneSymbol and EntrezGeneID
    raw_data.dropna(subset=['GeneSymbol', 'EntrezGeneID'], inplace=True)

    numeric_cols = raw_data.columns[1:-2]  # Exclude ProbeName, GeneSymbol, and EntrezGeneID
    for col in numeric_cols:
        raw_data[col] = 2 ** raw_data[col]

    # Return both the numeric data and gene identifiers
    numpy_array = raw_data.iloc[:, 1:-2].to_numpy()
    gene_identifiers = raw_data['GeneSymbol'].values
    return numpy_array, gene_identifiers


def creating_matrices():
    groups = 4
    samples = 12
    A = np.zeros((groups * samples, 4))
    B = np.zeros((groups * samples, 4))

    A_patterns = np.array([
        [1, 0, 0, 0],  # Male Non-Smoker
        [0, 1, 0, 0],  # Female Non-Smoker
        [0, 0, 1, 0],  # Male Smoker
        [0, 0, 0, 1]   # Female Smoker
    ])

    B_patterns = np.array([
        [1, 0, 1, 0],  # Male Non-Smoker
        [1, 0, 0, 1],  # Female Non-Smoker
        [0, 1, 1, 0],  # Male Smoker
        [0, 1, 0, 1]   # Female Smoker
    ])

    for i in range(groups):
        A[i * samples:(i + 1) * samples] = A_patterns[i]
        B[i * samples:(i + 1) * samples] = B_patterns[i]

    return A, B


# Function to calculate F-statistic for a given probe
def calculate_f_statistic(probe, A_mat, B_mat, df_numerator, df_denominator):
    identity_matrix = np.eye(48)
    num = probe.T @ (A_mat - B_mat) @ probe
    den = probe.T @ (identity_matrix - A_mat) @ probe

    if den != 0:
        f_statistic = (num * df_numerator) / (den * df_denominator)
        return f_statistic
    return None


def calculate_p_value(f_statistic, den, num):
    if f_statistic is not None:
        return 1 - f.cdf(f_statistic, den, num)
    return 1.0


def compute_pvalues(data, A, B):
    A_mat = A @ pinv(A.T @ A) @ A.T
    B_mat = B @ pinv(B.T @ B) @ B.T

    df_num = 48 - np.linalg.matrix_rank(A)
    df_den = np.linalg.matrix_rank(A) - np.linalg.matrix_rank(B)

    pvalues = []

    for probe in data:
        f_stat = calculate_f_statistic(probe, A_mat, B_mat, df_num, df_den)
        p_value = calculate_p_value(f_stat, df_den, df_num)
        pvalues.append(p_value)

    return np.array(pvalues)


def plot_pvalue_histogram(pvalues):
    plt.figure(figsize=(10, 6))
    plt.hist(pvalues, bins=100)
    plt.title('Distribution of the interaction P-values with 100 bins')
    plt.xlabel('P-values')
    plt.ylabel('Frequencies')
    plt.savefig('./pvalue_histogram.png')
    plt.show()


if __name__ == "__main__":
    file_path = '/Users/adityamanjunatha/Library/CloudStorage/OneDrive-IndianInstituteofScience/IISc Semester/5th Semester/Data Analytics/Assignments/Assignment 3/Raw Data_GeneSpring.txt'

    data, gene_identifiers = load_and_preprocess_gene_data(file_path)

    print("Shape of gene data:", data.shape)
    print("Length of gene data:", len(data))
    
    A, B = creating_matrices()
    print("Shape of A:", A.shape)
    print("Shape of B:", B.shape)
    
    p_values = compute_pvalues(data, A, B)

    # Print the largest and smallest p value
    print("Largest p-value:", np.max(p_values))
    print("Smallest p-value:", np.min(p_values))
    
    # Print the first 10 p values
    print("First 10 p-values:", p_values[:10])

    # Identify significant genes
    alpha = 0.05  # Significance level
    significant_mask = p_values < alpha
    significant_genes = gene_identifiers[significant_mask]
    significant_p_values = p_values[significant_mask]

    # Print significant genes
    #print("Significant Genes:")
    """
    ALREADY DONE AND PASTED BELOW
    # Saving significant genes and p-values to a CSV file
    with open('significant_genes.csv', 'w', newline='') as file:
        writer = csv.writer(file)
        writer.writerow(['Gene', 'P-value'])  # Write header
        writer.writerows(zip(significant_genes, significant_p_values))  # Write data

    print("Significant genes saved to significant_genes.csv")
    print("Number of significant genes:", len(significant_genes))
    """
    plot_pvalue_histogram(p_values)
    


"""

Shape of gene data: (31502, 48)
Length of gene data: 31502
Shape of A: (48, 4)
Shape of B: (48, 4)
Largest p-value: 1.0
Smallest p-value: 0.0001349089682542992
First 10 p-values: [0.56792206 0.97958811 0.44637048 0.84696689 0.86201909 0.87189086
 0.79322441 0.24918124 0.7002867  0.99075747]
 Number of significant genes: 432
Significant Genes:
SRF: 0.026642703045810734
LRP10: 0.011500401135567495
FASLG: 0.04952750337279532
LOC102724185: 0.03819494045422034
FAM65A: 0.026608753222810644
TOR2A: 0.04630350075620138
TCAF2: 0.022171586849648817
TF: 0.041024600417958745
VWF: 0.02296436833357729
EDN3: 0.03791237302792838
NKG7: 0.032259744517985744
FHOD1: 0.030212482567651078
GNA14: 0.040158893346480484
GPR108: 0.03275458272234788
MBD3L2: 0.030415721982690824
TMEM8A: 0.04189792723874297
LTC4S: 0.02173894099084206
ZMAT4: 0.010764654318840883
TTTY14: 0.0162246068544456
EFCAB12: 0.03086005486910337
EMX1: 0.017695088551746285
MFSD9: 0.02885898165043721
SPATC1L: 0.023516999994860788
CYP4B1: 0.030732665924990465
KLRC2: 0.03189676114655915
TF: 0.019415850436408366
POLD4: 0.04834541766324307
LINC00626: 0.00015468390388528874
ASRGL1: 0.024355116122519616
UNC5C: 0.03848781315859373
RASGRP4: 0.01345010404695246
CEP170B: 0.012936150760946008
DEFB125: 0.02250263759197313
F2RL2: 0.010366248124297872
NYX: 0.027540790861802167
MKNK2: 0.01859166476236307
COL5A3: 0.02828189299569206
NUMBL: 0.02826912320130348
DAO: 0.04059730730823996
CSF2RB: 0.03675721306493129
FBXO17: 0.018139579613251078
USHBP1: 0.04877196529049055
ACTG1P4: 0.023967767692016695
CMKLR1: 0.018948423836463002
B3GNT4: 0.0250795235254353
SLC22A23: 0.004195871387147609
GRIK2: 0.04550742086951787
TEAD3: 0.04429515668919959
TIAM1: 0.0019669875819372518
ZNF213: 0.0011727881739136414
TUBA3FP: 0.04506058846542793
JARID2-AS1: 0.030573237553716437
SULT1A4: 0.012118848610090827
STK4-AS1: 0.03583632659726521
TMEM150C: 0.026320405270976677
OR7D2: 0.011329914308004785
OSCP1: 0.030009778851986302
KCNG1: 0.03601594204039782
PRKD2: 0.019026788766389635
SPINK7: 0.0067974359926773475
SPTY2D1-AS1: 0.02332499754516104
WNT7A: 0.04155835678261599
ACTN1: 0.007620568529732474
TMEM80: 0.03853219961124632
PEBP4: 0.0351168678577487
SERPINB13: 0.04309928243241634
CCL5: 0.007419555198425298
THEMIS2: 0.012817002189250526
MAP3K3: 0.04007346711825277
SDCBP2: 0.027495612358170995
MARK2: 0.02455898323844463
NCKAP5L: 0.04652392431682617
PTPN6: 0.012511442801865003
HIST1H3D: 0.035347363153760636
AGER: 0.027296749079764426
CYHR1: 0.04038841086811151
PGS1: 0.01658355998483263
AKAP5: 0.006598367746240674
ZNF415: 0.019172854168105435
BIN3: 0.031123422391436617
ZNF471: 0.02863588808628892
MEGF6: 0.035982766301806635
DTWD2: 0.028989509946540815
IRS2: 0.011935855576246657
CCL8: 0.03762045860646912
EOMES: 0.013092857159974658
MBOAT7: 0.023193442723208224
MTFP1: 0.020516980618944913
TREML2: 0.04197043434109915
SLC9A9: 0.03561844614129517
ZBTB47: 0.019192468306716393
PPP2R2B: 0.044467976361063144
ARHGAP24: 0.045512449554060974
ADD1: 0.04817087699445466
CHRD: 0.04392112554725802
ACTN1: 0.006847077398240642
KIF19: 0.024923459653822033
ZFP30: 0.04096379979796705
EPOR: 0.036765112875221884
CCK: 0.030726261080911144
LINC01506: 0.03558577438806332
ZBTB47: 0.030409561541681396
CACNG8: 0.04503227233388363
IDS: 0.03874054573960084
ALDH3B2: 0.04984541109242513
HGSNAT: 0.04327859545737722
HECW2: 0.04627290051238264
LRP10: 0.04668782628009449
NREP: 0.021130251634884134
GFRA2: 0.026795362359880226
CECR2: 0.04759889696218744
TLN1: 0.044228467046883435
TBX20: 0.045179765842420005
AMPD2: 0.02653337402706779
RNASET2: 0.019296981867961138
HIST1H1C: 0.004776606067204092
LINC00944: 0.039703708528100456
ARAP1: 0.03428202908797362
CORO1A: 0.02160786841207618
MIF: 0.024630717823477033
KLHDC9: 0.021255142237278868
ZBTB48: 0.03950867503928157
HLA-C: 0.02604580432312531
WDR93: 0.027595836136511176
KCNK15: 0.02815397374358375
ZDHHC21: 0.016667033992708635
SNED1: 0.003959400449642714
LOC101928731: 0.04076540203885748
ACTN3: 0.0014130114348853695
MCF2L-AS1: 0.015317198767342943
TNRC18: 0.007890445160038562
MCEMP1: 0.02897701615635917
CDH26: 0.030757817487297
COL9A2: 0.01656238891305495
SEMA6A: 0.02998089324820119
SERPINA1: 0.039629160586771905
CMKLR1: 0.017926678888062653
MCF2L: 0.04729040540408147
HSPC081: 0.0018788069659875228
MROH7: 0.004786942390882287
ZDHHC11: 0.04785609881885611
HIST1H1D: 0.017158141066494714
KIRREL: 0.020091293046800796
HOXC13: 0.01911705893251736
GPR114: 0.042588576575115056
ZC3HAV1L: 0.04240108993441061
NRAV: 0.0482139702297415
GFAP: 0.03966452553901556
SULT1A1: 0.004714011003959184
LSR: 0.04405919030359551
TLR3: 0.03105536143869203
CCER1: 0.047891511217115434
CYP4F8: 0.03792298219613943
BTNL9: 0.03594067111460919
SLC17A7: 0.011919023480586488
C1QB: 0.026874369476443394
LOC100507316: 0.044020015867964224
MYOM1: 0.02725634538200894
S1PR5: 0.01588250173646999
CNTNAP5: 0.03940283816148438
AK1: 0.01856575366318125
HHLA3: 0.006777832844453546
ANKRD34A: 0.04188447644875015
LOC389641: 0.039643919768104996
SLC4A10: 0.011138643643298307
GZMB: 0.026671000698406222
OSBPL1A: 0.035399047679311346
PADI2: 0.012234240720740419
KIAA1211L: 0.020185605204521728
SHISA9: 0.032169702793289234
TRIM10: 0.01330667160307375
FADS2: 0.032130886197367814
MUC4: 0.01669382510946804
PMEL: 0.028579057392843388
DACT3: 0.023329560490321977
ALPP: 0.007509281677065327
OTUD7B: 0.03618659486457443
GM2A: 0.011833869245002515
STXBP2: 0.04687308591048034
TTC38: 0.046744600022427196
CACNG3: 0.03924567870114026
SLC46A2: 0.03316714416182631
INSM1: 0.0018726072987937936
EFCAB6: 0.04335014294632178
CYP11B1: 0.032926978100715876
RASA4: 0.00801936779963719
MVB12B: 0.025403430951562278
SYCE3: 0.03347928860222882
ADAM33: 0.02946809718124599
RARA-AS1: 0.03822021607744652
SLC9A9: 0.0320016921662889
WNT2B: 0.0431329069038201
MYBPC3: 0.01153226740200386
LINC01573: 0.011746565332337977
ITGA5: 0.029387041239315792
CCDC3: 0.03910711742436124
GZMK: 0.03156894606417082
CENPVP2: 0.03499600608506037
CHRDL1: 0.02774275259859771
CYP2S1: 0.010692199512707612
LINC00527: 0.048142310294903234
KISS1: 0.030292579849506396
C9orf57: 0.045382415593453684
FES: 0.01778072191365576
LILRB4: 0.006998839496052289
CDC42BPA: 0.02940147409398508
JAKMIP2: 0.04135430678047747
TCL6: 0.00022281831452664047
RPS6KA2: 0.041885537667262995
GM2A: 0.04837863448740232
AQP10: 0.0075674986523888155
GPI: 0.008820583529433157
KCNK10: 0.03807722904527766
PRORY: 0.028685603506470758
PDLIM3: 0.028330726077493984
YAP1: 0.03415739584744415
GPR68: 0.018029569219297104
GZMH: 0.04517255398753406
XCR1: 0.04226488739247247
NFATC2: 0.02750286404036406
KLRG1: 0.005221732554314462
OR52K2: 0.04036457152110284
GLI2: 0.03340481344822355
UNC45B: 0.008461070869635212
TCAF2: 0.03107036947848041
KLRD1: 0.04676284190708435
TRDN: 0.01848751224021561
PIGR: 0.03560976747496136
GRN: 0.03527362271221657
PGS1: 0.03588264529317464
TTTY21: 0.021984606616214153
NABP2: 0.044643050089627545
CMKLR1: 0.02749080646480051
OPRL1: 0.01102139821604009
HEATR9: 0.024366290854090256
MYBL1: 0.0007923489381861382
LOC101927181: 0.036187558769234296
MIDN: 0.0069165208581971616
RBM47: 0.03956343733926304
OVCH1-AS1: 0.01233116136979373
TMEM249: 0.023479771120478166
SLC4A4: 0.0013043733458624196
TGFBR3: 0.046878893049490555
VWA1: 0.03868068003463743
LINC00520: 0.021905356584349778
GYPA: 0.032898790921724874
AK4: 0.016038737291417915
GBX2: 0.049980237598778565
LANCL3: 0.03475661775267702
Sep-08: 0.03225783427111595
FSCN1: 0.011899976366884779
C1QTNF1: 0.037248530080175146
TMPRSS11GP: 0.04629903529955881
SCAI: 0.0341910146992519
ABCG4: 0.02979541291221799
CDHR1: 0.02947755239707106
ADAMTS3: 0.023055401925916152
PDE9A: 0.005156714951821018
MOBP: 0.02092411038184916
SCN8A: 0.044399393628790085
AWAT1: 0.019449050703220006
NUDT11: 0.006780152069254863
PILRA: 0.014942342123355434
TTC23: 0.003939668095929938
C12orf54: 0.01087382146378657
IRX6: 0.03972146600319115
PACSIN1: 0.022459830974559614
PZP: 0.0436651783167179
DNM3OS: 0.007880660626126912
HNF4A: 0.04930316459361439
ARHGAP24: 0.03935234833943313
GFER: 0.021619074381159065
CCDC171: 0.028325351003228305
HCRT: 0.049837288285472514
MOB3B: 0.018042047406773065
PPBPP2: 0.04735816641409718
LOC101929229: 0.03969301944380754
FBRS: 0.010201297360529882
GZMA: 0.0352280111799359
DPY19L2P2: 0.020335613811739095
MUC4: 0.03354177013517701
FOXP2: 0.04211920589148799
OLIG1: 0.04703141368285124
GPR97: 0.013924186598480381
C6orf118: 0.02069365169204651
GREM1: 0.04545034227950562
VSIG10: 0.02387232619002777
CYR61: 0.03970844221459835
IL33: 0.030569001880283553
ACAD10: 0.037527560127506465
SP3: 0.008270385595490315
MGAT4D: 0.022861672081940898
LCAT: 0.04630436373769309
RARRES2: 0.042109659507106656
HIST1H1E: 0.02872458777937903
PIK3R6: 0.017353532074347533
OSBPL6: 0.04369578466820501
SERPINB11: 0.02108567561343333
MYBL1: 0.010450872937037614
TPRG1: 0.045840439357412555
ACVR1B: 0.037747700710987875
RCVRN: 0.004899214476077107
GNAT1: 0.0221219730861566
RILP: 0.013006295382247623
LRRN3: 0.02905208622530997
SNED1: 0.009637825372639464
COL27A1: 0.03768488695625627
DRC7: 0.04692987505774138
SYTL4: 0.024895727604330453
ATP1B1: 0.03907942728459923
MYBL1: 0.0032843737549420604
FAM214B: 0.03958121484394739
PRSS21: 0.016120565486199778
KLRC4: 0.02240494275324978
ASB13: 0.03851001681974431
MEG3: 0.010332722013310258
CCDC62: 0.018529946881234105
SEMA4B: 0.004753541774310754
GABRG3: 0.04925173465021748
POLM: 0.031040014140106487
BANCR: 0.02715910330953286
MEF2D: 0.019279110282965917
MYO15B: 0.028427688655931704
FAM81A: 0.018258052889335463
CORIN: 0.02181996758005078
G6PD: 0.024423975476687176
JSRP1: 0.016168527248665354
SLC12A3: 0.015059000240442155
TNNI3: 0.025049269675618935
CENPL: 0.02429990496344181
HIPK3: 0.035772157895599066
RASGRP4: 0.005627355266910272
WDR62: 0.044062621933844914
KATNAL2: 0.029969686688561814
RHBDD2: 0.04259248945944749
SLAMF7: 0.02538003267922917
JAKMIP1: 0.048104095256372714
KHDRBS3: 0.033600718752175074
PON1: 0.04094757657283776
LINC00466: 0.04075138892860486
PIP: 0.02657158893252709
FAM95A: 0.0001349089682542992
CITED4: 0.00506533228142203
LPAR2: 0.0006119187426033568
C1orf115: 0.030112932595985353
DTHD1: 0.047226972370105536
KIAA0930: 0.04067903050156807
LAG3: 0.041484133432587944
GOLGA8R: 0.017929835176239473
C8orf34: 0.04483305973807716
MYO15B: 0.0035861557050091974
MAPRE3: 0.039840417261575056
PTGDR: 0.036392342701618285
KBTBD12: 0.0341177804186259
C1QA: 0.02264774017671367
SH2D1A: 0.026066462086684283
PRAM1: 0.04062051759187624
CDKN2B: 0.04652370849406351
EMILIN3: 0.021189090528751175
FAM162A: 0.040547914085901526
GNLY: 0.018016835597174263
CSF3R: 0.03294881221233048
C16orf93: 0.03475978122841128
SERPINB9: 0.03240700920370143
LINC00339: 0.04845770562088536
C18orf12: 0.021722645517451733
RNASET2: 0.04809572193714218
JAM2: 0.04852528146126733
TWF2: 0.04425916459001611
SLC22A18: 0.03736123643023159
IRS2: 0.022113340311132434
TBC1D2: 0.032459858949226095
NRCAM: 0.046335218095626574
STH: 0.037637296421992095
GPR83: 0.0428315532971284
LINC00461: 0.0352318613404925
EXOC3: 0.023391626910564844
ARHGEF4: 0.004366667659282841
CECR1: 0.028966062840223628
CDA: 0.020825293045862447
ASB13: 0.03265094417044612
TDRD12: 0.0363207160695479
HNF1A: 0.04553052496024956
RASAL2: 0.016299410382163426
PIANP: 0.047440711775895594
RGL3: 0.01968907930750896
LINC00942: 0.04315343892774748
LOC100131496: 0.048350185903017096
XCL1: 0.041190125343588346
NMUR1: 0.04068125192461203
ABHD2: 0.03112051594401566
CSRNP3: 0.046373059161178176
KLRG1: 0.010597694548721615
VIL1: 0.0382714498459783
CYP4F2: 0.01483779661948681
DKFZP434L187: 0.03330067927423386
MESP1: 0.008072433764956144
WWTR1: 0.01881222213176681
PADI2: 0.012470142577854504
STARD13: 0.018499648882567943
PLAC4: 0.016262940137696358
PDLIM7: 0.03349357211208848
GRPR: 0.026317659611271194
LINC01117: 0.009741664531984773
RASSF2: 0.020498129170900214
PTPRF: 0.03481790724795475
RHBDF1: 0.03603138692355201
MMP23B: 0.03909262998681051
MYBL1: 0.010732182907922994
PADI2: 0.012425291572747632
TBX21: 0.03836193233504159
LRP1B: 0.02477860499844331
NUB1: 0.020631005016466863
MEF2BNB: 0.03422160294218379
DBN1: 0.02105855564115977
CEACAM19: 0.021456074928532187
CCDC57: 0.04928707827148249
SLC4A4: 0.04677781945500026
HLA-G: 0.019115089432258703
RASIP1: 0.004872154245906257
C1QC: 0.018343383122960355
MGC57346: 0.02963817102403099
ME1: 0.04867658537351682
NBR2: 0.03186424598534354
MINK1: 0.04333055128753971
XCL2: 0.03491061355918479
TTLL6: 0.0365197170570406
DUXAP8: 0.020353676399811782
TIGD1: 0.02401593610712005
C9orf135: 0.019411429116209966
UNC93B1: 0.038969984380426315
ENO1: 0.04705713232725117


"""